name: Auto-Merge - ODH to RHODS

on:
  workflow_dispatch:
    inputs:
      repositories:
        type: choice
        description: select repositories
        options:
          - all
          - rhods-operator
          - opendatahub-operator
          - odh-manifests
          - odh-dashboard
          - kubeflow
          - modelmesh-serving
          - odh-model-controller
          - rest-proxy
          - modelmesh
          - modelmesh-runtime-adapter
          - data-science-pipelines
          - trustyai-explainability
          - trustyai-service-operator
          - data-science-pipelines-operator
          - codeflare-operator
          - distributed-workloads
          - kuberay
          - multi-cluster-app-dispatcher
          - text-generation-inference
          - caikit-tgis-serving
          - caikit-nlp
          - caikit
          - kserve
          - caikit-tgis-backend
  schedule:
    - cron: '0 0 * * *'

permissions:
  packages: write
  contents: read
  id-token: write

env:
  SOURCE_MAP: "src/config/source_map.yaml"
jobs:

  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.value }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: matrix
        run: |
          value=$(yq -o json $SOURCE_MAP)
          value=$(echo $value | jq -r '.git' | jq -c 'map(select(.automerge == "yes"))' | sed 's/ //g' | awk NF=NF RS= OFS=)
          if [[ "${{ github.event_name  }}" == "workflow_dispatch" ]] && [[ "${{ github.event.inputs.repositories }}" != "all" ]]
          then
            value=$(echo $value | jq -c 'map(select(.name == "${{ github.event.inputs.repositories }}"))' | sed 's/ //g' | awk NF=NF RS= OFS=)
          fi
          echo "repos=$value"
          length=$(echo $value | jq '. | length')
          echo "$length repo(s) will be auto-merged by this workflow"
          if [[ $length -eq 0 ]]
          then 
            echo "No valid repos available for auto-merge"
            exit 1
          fi
          echo "::set-output name=value::$value"
  build:
    needs: [ setup ]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        mapping: ${{ fromJSON(needs.setup.outputs.matrix) }}
    steps:
      - name: Generate github-app token
        id: app-token
        uses: getsentry/action-github-app-token@v2
        with:
          app_id: ${{ secrets.DEVOPS_APP_ID }}
          private_key: ${{ secrets.DEVOPS_APP_PRIVATE_KEY }}
      - id: git-configuration
        run: |
          echo "ignore = ${{ matrix.mapping.src.ignore }}"
          if [[ -z ${{ matrix.mapping.src.ignore }} ]]
          then
            echo "no files added to ignore"
          fi
          if [[ -n ${{ matrix.mapping.src.ignore }} ]]
          then
            echo "ignore = ${{ matrix.mapping.src.ignore }}"
          fi