#!/bin/bash

keytab=/etc/krb5.keytab
principal=$(klist -k "${keytab}" | sed -n '/.*---.*/,$p' | tail -n +2 | sort | uniq | awk '{ print $2 }' | head -n 1)
sudo kinit -f -k -t "${keytab}" "${principal}" || error "Cannot initialize kerberos ticket"

#sudo ./first_run.sh
export KRB5_KTNAME=FILE:/etc/krb5.keytab
ADVISORY="RHBA-2024:133289-01"
RELEASE="2.11.0"
sudo python3 main.py -e $ADVISORY

infected_files_counts=$(cat results/*/*.txt | grep 'Infected files' | sed -r 's/Infected files: ([0-9]+)/\1/g')
tot=0
for i in ${infected_files_counts[@]}; do
  let tot+=$i
  echo $i
done
echo "Total: $tot"

if [[ $tot > 0 ]]; then
  echo "Infected files found while scanning $ADVISORY advisory for $RELEASE release."
  exit 1
else
  echo "No infected files found while scanning $ADVISORY advisory for $RELEASE release."
fi