#!/bin/bash

#container=$(buildah from "registry.access.redhat.com/ubi9/python-311:1-17.1690899890")
container=$(buildah from "registry.access.redhat.com/ubi8:latest")
mntpoint=$(buildah mount $container)

buildah run --user 0 $container rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
buildah run --user 0 $container dnf update -y
buildah run --user 0 $container dnf install -y podman tar jq clamav clamav-update

echo "root:20000:35536" > $mntpoint/etc/subuid
echo "root:20000:35536" > $mntpoint/etc/subgid

mkdir $mntpoint/results || true
chown 1001:0 $mntpoint/results
mkdir $mntpoint/app || true
cp main.sh $mntpoint/app
chown 1001:0 $mntpoint/app/main.sh
chmod a+x $mntpoint/app/main.sh

buildah config --cmd /app/main.sh $container

buildah commit $container clamav-container-scanner:latest
buildah unmount $container
# buildah rm $container
