#!/bin/bash

set -e
podman pull --tls-verify=false $IMAGE_NAME
podman save $IMAGE_NAME > /tmp/image.tar
mkdir /tmp/image
tar xf /tmp/image.tar --wildcards -C /tmp/image
cd /tmp/image
mkdir layers_extracted
for itm in $(cat manifest.json | jq -r '.[0].Layers[]')
do
    NO_EXT=$(echo $itm | cut -d "." -f 1)
    mkdir -p /tmp/image/layers_extracted/$NO_EXT
    tar xf $itm --wildcards -C /tmp/image/layers_extracted/$NO_EXT/
done
cd /tmp/image/layers_extracted/
OUTPUT_FILENAME=$(echo $IMAGE_NAME | rev | cut -d "/" -f1 | rev).txt
clamscan -o --stdout -r ./ > /results/$OUTPUT_FILENAME
